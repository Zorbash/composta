// Generated by CoffeeScript 1.6.2
(function() {
  var Composta;

  Composta = (function() {
    function Composta() {
      this.cacheElements();
      this.compileTemplates();
      this.setSearchResultsPosition();
      this.initializeSearchButton();
      this.bindHandlers();
      this.candidates = {};
    }

    Composta.prototype.search = function(q) {
      return $.get("/search/" + q);
    };

    Composta.prototype.cacheElements = function() {
      this.$el = $('body');
      this.$input = this.$el.find('.js-input');
      this.$search_button = this.$el.find('.js-submit');
      this.$search_results = this.$el.find('.js-search-results');
      this.$candidates = this.$el.find('.js-candidates');
      this.$candidate_info = this.$el.find('.js-candidate-info');
      return this.$seach_tip = this.$el.find('.js-search-tip');
    };

    Composta.prototype.compileTemplates = function() {
      var k, v, _ref, _results;

      _ref = Templates.source;
      _results = [];
      for (k in _ref) {
        v = _ref[k];
        _results.push(Templates.compiled[k] = Hogan.compile(v));
      }
      return _results;
    };

    Composta.prototype.startSearch = function() {
      var _this = this;

      this.search_button.start();
      return this.search(this.$input.val()).then(function(response) {
        _this.search_button.stop();
        _this.renderSearchResults(response);
        return _this.cached_response = response;
      });
    };

    Composta.prototype.addCandidate = function(candidate) {
      return this.$candidates.append(Templates.compiled.candidate_list_item.render(candidate));
    };

    Composta.prototype.initializeSearchButton = function() {
      return this.search_button = Ladda.create(this.$search_button[0]);
    };

    Composta.prototype.setSearchResultsPosition = function() {
      var input_position;

      input_position = this.$input.position();
      return this.$search_results.css({
        left: input_position.left,
        top: input_position.top + 50
      });
    };

    Composta.prototype.renderSearchResults = function(results) {
      return this.$search_results.html(Templates.compiled.search_results.render({
        results: results
      }));
    };

    Composta.prototype.renderCandidateInfo = function(candidate) {
      return this.$candidate_info.html(Templates.compiled.candidate_info.render(candidate));
    };

    Composta.prototype.bindHandlers = function() {
      var _this = this;

      this.$input.on('keyup', function(e) {
        return _this.onQueryKeypress(e);
      });
      this.$search_button.on('click', function() {
        return _this.startSearch();
      });
      this.$el.on('click', '.js-result', function(e) {
        return _this.onResultClick(e);
      });
      this.$el.on('click', '.js-show-more', function(e) {
        return _this.onCandidateShowMoreClick(e);
      });
      this.$el.on('click', '.js-remove', function() {
        return _this.onCandidateInfoRemoveClick();
      });
      return $(window).resize(function() {
        return _this.setSearchResultsPosition();
      });
    };

    Composta.prototype.onQueryKeypress = function(e) {
      if (e.keyCode === 13) {
        this.startSearch();
      }
      if (this.$input.val() === '') {
        return this.$search_results.html('');
      }
    };

    Composta.prototype.onResultClick = function(e) {
      var index, new_candidate, _ref;

      index = $(e.currentTarget).index();
      this.$search_results.html('');
      this.$seach_tip.hide();
      if (this.candidates[(_ref = this.cached_response[index]) != null ? _ref.name : void 0] == null) {
        new_candidate = this.cached_response[index];
        this.candidates[this.cached_response[index].name] = new_candidate;
        return this.addCandidate(new_candidate);
      }
    };

    Composta.prototype.onCandidateShowMoreClick = function(e) {
      var $target, name;

      $target = $(e.currentTarget);
      name = $target.data('name');
      return this.renderCandidateInfo(this.candidates[name]);
    };

    Composta.prototype.onCandidateInfoRemoveClick = function() {
      return this.$candidate_info.html('');
    };

    return Composta;

  })();

  $(function() {
    return new Composta();
  });

}).call(this);
